# XGDataTools Copilot Instructions

## Project Overview

XGDataTools is a Ruby toolkit for working with eXtreme Gammon (XG) file formats used in backgammon analysis software.

## Domain Context

- **eXtreme Gammon**: Professional backgammon analysis software
- **XG files**: Binary format with game data, positions, analysis, and rollouts
- **File format**: Complex nested binary structures with ZLib compression
- **Endianness**: Little-endian byte order throughout

## Architecture

### Core Modules

- **`xgutils.rb`**: CRC32, date conversion, UTF16 string handling
- **`xgimport.rb`**: File segmentation and stream processing  
- **`xgstruct.rb`**: Hash-based record classes with binary deserialization
- **`xgzarc.rb`**: ZLib archive handling
- **`extractxgdata.rb`**: CLI application for data extraction

## Ruby Patterns

### Hash-based Records
```ruby
class GameRecord < Hash
  def initialize(**kwargs)
    defaults = { 'Name' => 'Game', 'Type' => 0 }
    super(defaults.merge(kwargs))
  end
  
  def method_missing(method_name, *args)
    if method_name.to_s.end_with?('=')
      self[method_name.to_s.chomp('=')] = args.first
    else
      self[method_name.to_s]
    end
  end
end
```

### Binary Data Processing
```ruby
def fromstream(stream)
  data = stream.read(RECORD_SIZE)
  data.unpack('L<L<f<')  # Little-endian: uint32, uint32, float
end
```

### Error Handling
```ruby
class XGImport::Error < StandardError
  attr_reader :filename, :error
  
  def initialize(error, filename)
    @error = error
    @filename = filename
    super("XG Import Error processing '#{filename}': #{error}")
  end
end
```

## Development Standards

### Ruby Style
- Use modules for namespacing
- Snake_case naming conventions
- String keys for Hash compatibility
- Explicit binary mode for file I/O

### Testing
- **Minitest framework** for all tests
- One test file per module
- Test edge cases and error conditions
- Use test helpers for common operations

```ruby
class TestXGUtils < Minitest::Test
  def test_method_with_valid_input
    result = XGUtils.method(valid_input)
    assert_equal expected_result, result
  end
  
  def test_method_with_error
    assert_raises(StandardError) do
      XGUtils.method(invalid_input)
    end
  end
end
```

### Dependencies
- **Standard library only** (no external gems)
- Exception: SimpleCov for test coverage
- Core libraries: `zlib`, `date`, `tempfile`, `fileutils`

## Common Patterns

### File I/O
```ruby
File.open(filename, 'rb') do |file|
  file.binmode
  data = file.read(size)
end
```

### Method Access
```ruby
def method_missing(method_name, *args)
  if method_name.to_s.end_with?('=')
    key = method_name.to_s.chomp('=')
    self[key] = args.first
  elsif has_key?(method_name.to_s)
    self[method_name.to_s]
  else
    super
  end
end
```

### Error Context
```ruby
begin
  process_file(filename)
rescue => e
  raise Error.new("Failed to process #{filename}: #{e.message}", filename)
end
```

## Key Considerations

- **Binary data**: Always use little-endian format (`<`) in pack/unpack
- **Stream processing**: Handle large files efficiently 
- **Hash inheritance**: Support both `obj['key']` and `obj.key` syntax
- **Error handling**: Provide meaningful context with filenames
- **Memory efficiency**: Use streaming for large file operations